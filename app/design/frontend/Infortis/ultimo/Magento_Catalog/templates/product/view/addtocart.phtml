<?php
/**
 * Copyright Â© Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */

// @codingStandardsIgnoreFile

/** @var $block \Magento\Catalog\Block\Product\View */
?>
<?php $_product = $block->getProduct(); ?>
<?php
$model = \Magento\Framework\App\ObjectManager::getInstance();
$productSku = $_product->getSku();
$price = $_product->getPrice();
$VendorProduct = $model->create('Ced\CsMarketplace\Model\Vproducts')->getCollection()->addFieldToFilter('sku',$productSku)->addFieldToFilter('check_status',['nin'=>3])->getFirstItem();
$customer = $model->create('Magento\Customer\Model\Session');
$sessionId = $customer->getVendorId();
$VendorId = $VendorProduct->getVendorId();

// whether this is the current seller's product
$userProduct = $sessionId == $VendorId;
if($userProduct){
  $buttonTitle = __('Edit');
  $buttonHtml = '<button type="submit"
                    title="'.$buttonTitle.'"
                    class="action primary tocart product-edit custom-button"
                    style="float: left; margin-bottom: 0.3em; width: 100%; cursor: pointer;"
                    id="product-addtocart">
                    <span>'.$buttonTitle.'</span>
                </button>';
}else{
  $buttonTitle = __('Purchase');
  $buttonHtml = '<button type="submit"
                    title="'.$buttonTitle.'"
                    class="action primary tocart"
                    style="float: left; margin-bottom: 0.3em; width: 75%; cursor: pointer;"
                    id="product-addtocart">
                    <span>'.$buttonTitle.'</span>
                </button>';
}

$resource = $model->get('Magento\Framework\App\ResourceConnection');
$connection = $resource->getConnection();
//Select Data from table
$sql = "SELECT value FROM MagentoQuickstartDB.ced_csmarketplace_vendor_int WHERE value_id = '".$VendorId."'";
$result = $connection->fetchAll($sql);
if(count($result) > 0 && isset($result[0]['value']) && $result[0]['value'] != null){
  $seller_cust_id = $result[0]['value'];
}// end if
?>
<?php if ($_product->isSaleable()): ?>
<div class="box-tocart">
    <div class="fieldset">
        <?php if ($block->shouldRenderQuantity()): ?>
        <div class="field qty">
            <label class="label" for="qty"><span><?php /* @escapeNotVerified */ echo __('Qty') ?></span></label>
            <div class="control">
                <input type="number"
                       name="qty"
                       id="qty"
                       maxlength="12"
                       value="<?php /* @escapeNotVerified */ echo $block->getProductDefaultQty() * 1 ?>"
                       title="<?php /* @escapeNotVerified */ echo __('Qty') ?>" class="input-text qty"
                       data-validate="<?php echo $block->escapeHtml(json_encode($block->getQuantityValidators())) ?>"
                       />
            </div>
        </div>
        <?php endif; ?>
        <div class="actions">
            <?php echo $buttonHtml ?>
<?php if (!$userProduct): ?>
              <a href="#"
                    title=""
                    class="action primary custom-button"
                    style="float: left; margin-bottom: 0.3em; width: 75%; cursor: pointer;"
                    id="product-offer-button">
                    <span>Send Offer</span>
              </a>
              <a href="#"
                    title=""
                    class="action primary custom-button contact-seller"
                    style="float: left; width: 75%; cursor: pointer;"
                    id="product-message-button">
                    <span>Contact Seller</span>
              </a>
<?php endif; ?>
<?php if ($userProduct): ?>
              <a href="#"
                    title=""
                    class="action primary custom-button product-delete"
                    style="float: left; margin-bottom: 0.3em; width: 100%; cursor: pointer;"
                    id="product-delete-button">
                    <span>Delete</span>
              </a>
<?php endif; ?>
            <?php echo $block->getChildHtml('', true) ?>
        </div>
    </div>
</div>
<div style="display: none" id="contact-seller-modal">
</form>
  <form method="post" action="/csmessaging/frontend/savechat" id="contact-seller-form">
    <div class="row" style="margin-bottom: 1em">
      <div class="col-md-2">
        <strong>Item:</strong>
      </div>
      <div class="col-md-6">
        <span class="item-name"></span>
      </div>
    </div>
    <div class="row">
      <div class="col-md-2">
        <strong>Message:</strong>
      </div>
      <div class="col-md-8">
        <textarea id="text_email_contact_seller" rows="10" required></textarea>
      </div>
    </div>
  </form>
</div>
<div style="display: none" id="make-offer-modal">
  <form method="post" action="/csmessaging/frontend/savechat" id="make-offer-form">
    <input type="hidden" id="email_subject" value="<?= $_product->getName() ?>" />
    <input type="hidden" id="vendor_id" value="<?= $VendorId ?>" />
    <input type="hidden" id="seller_cust_id" value="<?= $seller_cust_id ?>" />
    <input type="hidden" id="sent_to_vendor" value="Y" />
    <div class="row" style="margin-bottom: 1em">
      <div class="col-md-2">
        <strong>Item:</strong>
      </div>
      <div class="col-md-6">
        <span class="item-name"></span>
      </div>
    </div>
    <div class="row" style="margin-bottom: 1em">
      <div class="col-md-2">
        <strong>Offer ($):</strong>
      </div>
      <div class="col-md-4">
        <input type="number" id="offer_price" min="<?= 0.75 * $price ?>" required step="1" />
      </div>
    </div>
    <div class="row">
      <div class="col-md-2">
        <strong>Message:</strong>
      </div>
      <div class="col-md-8">
        <textarea id="text_email_offer" rows="10" required></textarea>
      </div>
    </div>
  </form>
</div>
<div style="display: none" id="delete-item-modal">
  <form method="post" action="/csmessaging/frontend/savechat" id="delete-item-form">
    <div class="row" style="margin-bottom: 1em">
      <div class="col-md-12" style="margin-left: 1em;">
        <strong>Are you sure you want to delete this listing?</strong>
      </div>
    </div>
  </form>
</div>

<?php endif; ?>
<?php if ($block->isRedirectToCartEnabled()) : ?>
    <script type="text/x-magento-init">
    {
        "#product_addtocart_form": {
            "Magento_Catalog/product/view/validation": {
                "radioCheckboxClosest": ".nested"
            }
        }
    }
</script>
<?php else : ?>
    <script type="text/x-magento-init">
    {
        "#product_addtocart_form": {
            "Magento_Catalog/js/validate-product": {}
        }
    }
</script>
<?php endif; ?>
<style>
.product-info-main .box-tocart .action.tocart, .product-options-bottom .box-tocart .action.tocart, .bundle-options-container .box-tocart .action.tocart, .product-info-main .box-tocart .action.instant-purchase, .product-options-bottom .box-tocart .action.instant-purchase, .bundle-options-container .box-tocart .action.instant-purchase {
  min-width: 179px;
}
#offer_price-error, #text_email_offer-error, #text_email_contact_seller-error {
  color: #e02b27;
}
.custom-button {
  line-height: 2.2rem !important;
  padding: 15px 17px !important;
  font-size: 1.8rem !important;
  min-width: 179px;
}
.product-info-main .product-info-stock-sku {
  padding-bottom: 0px;
}
@media (max-width: 575.98px) {
  .tocart, .custom-button {
    width: 100% !important;
  }
  .contact-seller {
    margin-bottom: 1em;
  }
}
.modal-inner-wrap {
  width: 40% !important;
}
.send-button {
  float: right;
}
.delete-button {
  background-color: #db3b21;
  border-color: #db3b21;
  color: #ffffff;
  text-shadow: 1px 1px 0 rgba(0,0,0,0.25);
}
@media (max-width: 575.98px) {
  .modal-popup.modal-slide._inner-scroll .modal-inner-wrap {
      height: auto;
      width: 100% !important;
      min-height: 100%;
  }
  .modal-footer {
    padding-bottom: 0 !important;
    margin-top: 0 !important;
  }
  .modal-content {
    padding-bottom: 0 !important;
  }
}
<?php
if($userProduct){
?>
.custom-button {
  min-width: 12.5em;
}
<?php
}// end if user product
?>
</style>
<script>
require(['jquery', 'Magento_Ui/js/modal/modal'], ($, modal) => {

$(document).ready(() => {
    // fix for ios safari
    $('.authorization-link a:first').css('cursor', 'pointer');

    $('.product-edit').click((e) => {
      e.preventDefault();
      window.location = '/sell?id=<?= $_product->getId(); ?>';
    });

    $('.product-delete').click(() => {
      var deleteOptions = {
        type: 'popup',
        responsive: true,
        innerScroll: true,
        title: 'Delete Listing - <?= $_product->getName() ?>',
        buttons: [{
          text: $.mage.__('Delete'),
          class: 'delete-button',
          click: function () {
            let product_id = <?= $_product->getId() ?>;
            $.post('/api/product/delete', { product_id }, (response) => {
              if(response.success == 'Y'){
                window.location = '/customer/account/listings/';
              }
            });
          }// end click function
        }]
      };
      var popup = modal(deleteOptions, $('#delete-item-modal'));
      $('#delete-item-modal').modal('openModal');
    });

    var contactOptions = {
      type: 'popup',
      responsive: true,
      innerScroll: true,
      title: 'Contact Seller - ' + $('.listedBy:first').text().replace('Listed by: ', ''),
      buttons: [{
        text: $.mage.__('Send'),
        class: 'send-button',
        click: function () {
          if($('#contact-seller-form').valid()){
            var data = {
              'vendor_id': $('#vendor_id').val(),
              'seller_cust_id': $('#seller_cust_id').val(),
              'email_subject': $('#email_subject').val(),
              'text_email': $('#text_email_contact_seller').val(),
              'product_id': '<?= $_product->getId() ?>'
            };
            $.post('/csmessaging/frontend/savechat', data, (response) => {
              $('#text_email_contact_seller').val('');
              this.closeModal();
            });
          }// end if form valid
        }// end click function
      }]
    };

    $('#contact-seller-form').submit(() => false);
    $('#make-offer-form').submit(() => false);

    var offerOptions = {
      type: 'popup',
      responsive: true,
      innerScroll: true,
      title: 'Send Offer - ' + $('.listedBy:first').text().replace('Listed by: ', ''),
      buttons: [{
        text: $.mage.__('Send'),
        class: 'send-button',
        click: function () {
          if($('#make-offer-form').valid()){
            var data = {
              'vendor_id': $('#vendor_id').val(),
              'seller_cust_id': $('#seller_cust_id').val(),
              'email_subject': $('#email_subject').val(),
              'text_email': $('#text_email_offer').val(),
              'offer_price': $('#offer_price').val(),
              'is_offer': 'Y',
              'product_id': '<?= $_product->getId() ?>'
            };
            $.post('/csmessaging/frontend/savechat', data, (response) => {
              $('#text_email_contact_seller').val('');
              this.closeModal();
            });
          }// end if form valid
        }// end click function
      }]
    };
    $('#product-message-button').click(() => {
<?php
  if($customer->isLoggedIn()){
?>
    $('.item-name').html($('.page-title:first').text());
    var popup = modal(contactOptions, $('#contact-seller-modal'));
    $('#contact-seller-modal').modal('openModal');
<?php
  }else{
?>
    let login_uri = $('.authorization-link a:first')[0].href;
    window.location = login_uri;
<?php
  }// end if customer is logged in
?>
  });
  $('#product-offer-button').click(() => {
<?php
  if($customer->isLoggedIn()){
?>
    $('.item-name').html($('.page-title:first').text());
    var popup = modal(offerOptions, $('#make-offer-modal'));
    $('#make-offer-modal').modal('openModal');
<?php
  }else{
?>
    let login_uri = $('.authorization-link a:first')[0].href;
    window.location = login_uri;
<?php
  }// end if customer is logged in
?>
    });
  });
});
</script>
