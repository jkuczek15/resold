<?php
/**
 * Copyright Â© Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */

?>
<style>
.subcategory {
  display: none;
}
.lowestcategory {
  display: none;
}
.image_input {
  display: none;
}
</style>

<form class="form"
      action="<?php /* @escapeNotVerified */ echo $block->getFormAction(); ?>"
      id="sell-form"
      method="post"
      data-hasrequired="<?php /* @escapeNotVerified */ echo __('* Required Fields') ?>">
    <fieldset class="fieldset" id="app">
        <div class="field name required">
            <label class="label" for="name"><span><?php /* @escapeNotVerified */ echo __('Name') ?></span></label>
            <div class="control">
                <input name="name" id="name" title="<?php /* @escapeNotVerified */ echo __('Name') ?>" value="<?php echo $block->escapeHtml($this->helper('Magento\Contact\Helper\Data')->getPostValue('name')) ?>" class="input-text" type="text" data-validate="{required:true}"/>
            </div>
        </div>
        <div class="field price required ">
            <label class="label" for="price"><span><?php /* @escapeNotVerified */ echo __('Price') ?></span></label>
            <div class="control">
                <input name="price" id="price" title="<?php /* @escapeNotVerified */ echo __('Price') ?>" value="<?php echo $block->escapeHtml($this->helper('Magento\Contact\Helper\Data')->getPostValue('price')) ?>" class="input-text" type="number" data-validate="{required:true, number: true}" data-msg-number="Please enter a valid number" />
            </div>
        </div>
        <div class="field category required">
            <label class="label" for="category_select"><span><?php /* @escapeNotVerified */ echo __('1st Category') ?></span></label>
            <div class="control">
                <select name="category" id="category_select">
                  <option value=""></option>
                  <option v-for="(data, category) in categories" v-bind:value="category">
                  {{ category }}
                  </option>
                </select>
            </div>
        </div>
        <div class="field subcategory required">
            <label class="label" for="subcategory_select"><span><?php /* @escapeNotVerified */ echo __('2nd Category') ?></span></label>
            <div class="control">
                <select name="subcategory" id="subcategory_select">
                  <option value=""></option>
                  <option v-for="(data, subcategory) in subcategories" v-bind:value="subcategory">
                  {{ subcategory }}
                  </option>
                </select>
            </div>
        </div>
        <div class="field lowestcategory required">
            <label class="label" for="lowestcategory_select"><span><?php /* @escapeNotVerified */ echo __('3rd Category') ?></span></label>
            <div class="control">
                <select name="lowestcategory" id="lowestcategory_select">
                  <option value=""></option>
                  <option v-for="lowestcategory in lowestcategories" v-bind:value="lowestcategory.id">
                  {{ lowestcategory.name }}
                  </option>
                </select>
            </div>
        </div>
        <div class="field condition required">
            <label class="label" for="condition"><span><?php /* @escapeNotVerified */ echo __('Condition') ?></span></label>
            <div class="control">
                <select name="condition" id="conditon">
                  <option value=""></option>
                  <option value="new">New</option>
                  <option value="like_new">Like New</option>
                  <option value="good">Good</option>
                  <option value="fair">Fair</option>
                </select>
            </div>
        </div>
        <div class="field condition required">
            <label class="label" for="local_global"><span><?php /* @escapeNotVerified */ echo __('Local / Global') ?></span></label>
            <div class="control">
                <input type="checkbox" value="local" /> Local <span style="margin-right: 1.5em"></span>
                <input type="checkbox" value="global" /> Global
            </div>
        </div>
        <div class="field images required">
            <label class="label" for="images"><span><?php /* @escapeNotVerified */ echo __('Images') ?></span></label>
            <div class="control">
              <input type="file" id="image_0" />
              <span v-for="index in num_images-1" :key="index">
                <input type="file" v-bind:id="'image_'+index" class="image_input" />
              </span>
            </div>
        </div>
        <div class="field description required">
            <label class="label" for="comment"><span><?php /* @escapeNotVerified */ echo __('Description') ?></span></label>
            <div class="control">
                <textarea name="description" id="description" title="<?php /* @escapeNotVerified */ echo __('Description') ?>" class="input-text" cols="5" rows="3" data-validate="{required:true}"><?php echo $block->escapeHtml($this->helper('Magento\Contact\Helper\Data')->getPostValue('description')) ?></textarea>
            </div>
        </div>
        <?php echo $block->getChildHtml('form.additional.info'); ?>
    </fieldset>
    <div class="actions-toolbar">
        <div class="primary">
            <input type="hidden" name="hideit" id="hideit" value="" />
            <button type="submit" title="<?php /* @escapeNotVerified */ echo __('Submit') ?>" class="action submit primary">
                <span><?php /* @escapeNotVerified */ echo __('Submit') ?></span>
            </button>
        </div>
    </div>
</form>

<script>
require([
    "jquery",
    "mage/mage",
    "mage/validation",
    "vue"
], ($, mage, validation, Vue) => {
    // initialize a new Vue app
    var app = new Vue({
      el: '#app',
      data: {
        categories: [],
        subcategories: [],
        lowestcategories: [],
        num_images: 10
      }
    });

    // api requests
    $.get('/api/categories', (data) => app.categories = data);

    // validation
    $('#sell-form').mage('validation', {
        messages: {
          'price': {'validate-value-less-than-20': 'Please enter a price greater than $20.', 'number': 'Please enter a valid number'},
        }
    });

    // category change function
    $('#category_select').change(function(){
      let category = this.value;
      if(category == ''){
        app.subcategories = [];
        $('.lowestcategory').hide();
      }else{
        app.subcategories = app.categories[category];
        $('#subcategory_select').val('');
        $('#lowestcategory_select').val('');
        $('.lowestcategory').hide();
        $('.subcategory').show();
      }
    });

    // subcategory change function
    $('#subcategory_select').change(function(){
      let subcategory = this.value;
      if(subcategory == ''){
        app.lowestcategories = [];
        $('.lowestcategory').hide();
      }else{
        app.lowestcategories = app.subcategories[subcategory];
        $('#lowestcategory_select').val('');
        $('.lowestcategory').show();
      }
    });

    // image change function
    $('.image_input, #image_0').change(function(){
      let id = Number.parseInt((this.id.split('_'))[1]);
      $(`#image_${id+1}`).show();
    });
});
</script>
