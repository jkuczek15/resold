<?php
/**
* Sell Form
*/
$new_attr_id = 227;
?>
<div id="error" class="alert" style="display: none">
 <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
 <strong><span id="error-text"></span></strong>
</div>
<form class="form" action="/api/product" method="post" id="sell_form" enctype="multipart/form-data" data-hasrequired="<?php /* @escapeNotVerified */ echo __('* Required Fields') ?>">
    <input type="hidden" name="latitude" id="latitude" value="" />
    <input type="hidden" name="longitude" id="longitude" value="" />
    <fieldset class="fieldset" id="app">
        <div class="field name">
            <label class="label" for="name"><span><?php /* @escapeNotVerified */ echo __('Item Name') ?></span></label>
            <div class="control">
                <input name="name" id="name" title="<?php /* @escapeNotVerified */ echo __('Item Name') ?>" value="<?php echo $block->escapeHtml($this->helper('Magento\Contact\Helper\Data')->getPostValue('name')) ?>" class="input-text" type="text" data-validate="{required:true, maxlength: 24}" v-model="form_data.name" />
            </div>
        </div>
        <div class="field title_description">
            <label class="label" for="title_description"><span><?php /* @escapeNotVerified */ echo __('Title Description') ?></span></label>
            <div class="control">
                <input name="title_description" id="title_description" title="<?php /* @escapeNotVerified */ echo __('Title Description') ?>" value="<?php echo $block->escapeHtml($this->helper('Magento\Contact\Helper\Data')->getPostValue('title_description')) ?>" class="input-text" type="text" data-validate="{required:true, maxlength: 42}" v-model="form_data.title_description" />
            </div>
        </div>
        <div class="field price">
            <label class="label" for="price"><span><?php /* @escapeNotVerified */ echo __('Price') ?></span></label>
            <div class="control">
                <input name="price" id="price" title="<?php /* @escapeNotVerified */ echo __('Price') ?>" value="<?php echo $block->escapeHtml($this->helper('Magento\Contact\Helper\Data')->getPostValue('price')) ?>" class="input-text" type="number" data-validate="{required:true, number: true, min: 20}" v-model="form_data.price" />
            </div>
        </div>
        <div class="field category">
            <label class="label" for="category_select"><span><?php /* @escapeNotVerified */ echo __('1st Category') ?></span></label>
            <div class="control">
                <select name="category" id="category_select" data-validate="{required:true}" v-model="form_data.category">
                  <option value=""></option>
                  <option v-for="(data, category) in categories" v-bind:value="category">
                  {{ category }}
                  </option>
                </select>
            </div>
        </div>
        <div class="field subcategory">
            <label class="label" for="subcategory_select"><span><?php /* @escapeNotVerified */ echo __('2nd Category') ?></span></label>
            <div class="control">
                <select name="subcategory" id="subcategory_select" data-validate="{required:true}" v-model="form_data.subcategory">
                  <option value=""></option>
                  <option v-for="(data, subcategory) in subcategories" v-bind:value="subcategory">
                  {{ subcategory }}
                  </option>
                </select>
            </div>
        </div>
        <div class="field lowestcategory">
            <label class="label" for="lowestcategory_select"><span><?php /* @escapeNotVerified */ echo __('3rd Category') ?></span></label>
            <div class="control">
                <select name="lowestcategory" id="lowestcategory_select" data-validate="{required:true}" v-model="form_data.lowestcategory">
                  <option value=""></option>
                  <option v-for="lowestcategory in lowestcategories" v-bind:value="lowestcategory.id">
                  {{ lowestcategory.name }}
                  </option>
                </select>
            </div>
        </div>
        <div class="field condition">
            <label class="label" for="condition"><span><?php /* @escapeNotVerified */ echo __('Condition') ?></span></label>
            <div class="control">
                <select name="condition" id="conditon" data-validate="{required:true}" v-model="form_data.condition">
                  <option value=""></option>
                  <option value="<?= $new_attr_id ?>">New</option>
                  <option value="<?= $new_attr_id + 1 ?>">Like New</option>
                  <option value="<?= $new_attr_id + 2 ?>">Good</option>
                  <option value="<?= $new_attr_id + 3 ?>">Used</option>
                </select>
            </div>
        </div>
        <div class="field local">
            <label class="label" for="local"><span><?php /* @escapeNotVerified */ echo __('Local / Global') ?></span></label>
            <div class="control">
                <input type="checkbox" value="231" name="local_global[]" id="local" data-validate="{'validate-local-global': true}" v-model="form_data.local" /> Local <span style="margin-right: 1.5em"></span>
                <input type="checkbox" value="232" name="local_global[]" id="global" v-model="form_data.global" /> Global
                <div style="color: #e02b27; font-size: 1.2rem;" class="custom-error" id="local_global_error" v-if="local_global_error" v-cloak>Please select at least one option.</div>
            </div>
        </div>
        <div class="field images">
            <label class="label" for="images"><span><?php /* @escapeNotVerified */ echo __('Images') ?></span></label>
            <div class="control">
              <input type="file" id="image_0" data-validate="{'required-file': true}" data-msg-required-file="Please select an image." name="images[]" accept="image/*" />
              <span v-for="index in num_images-1" :key="index">
                <input type="file" v-bind:id="'image_'+index" name="images[]" class="image_input" accept="image/*" />
              </span>
            </div>
        </div>
        <div class="field description">
            <label class="label" for="comment"><span><?php /* @escapeNotVerified */ echo __('Details') ?></span></label>
            <div class="control">
                <textarea name="description" id="description" title="<?php /* @escapeNotVerified */ echo __('Description') ?>" class="input-text" cols="5" rows="3" data-validate="{required:true}" v-model="form_data.description"><?php echo $block->escapeHtml($this->helper('Magento\Contact\Helper\Data')->getPostValue('description')) ?></textarea>
            </div>
        </div>
        <?php echo $block->getChildHtml('form.additional.info'); ?>
    </fieldset>
    <div class="actions-toolbar">
        <div class="primary">
            <input type="hidden" name="hideit" id="hideit" value="" />
            <button type="submit" id="submit" title="<?php /* @escapeNotVerified */ echo __('Submit') ?>" class="action submit primary" disabled>
                <span><?php /* @escapeNotVerified */ echo __('Submit') ?></span>
            </button>
        </div>
    </div>
</form>
<style>
/* The alert message box */
.alert {
   padding: 20px;
   background-color: #f2dede; /* Red */
   color: #a94442;
   margin-bottom: 15px;
}

/* The close button */
.closebtn {
   margin-left: 15px;
   color: #565252;
   font-weight: bold;
   float: right;
   font-size: 22px;
   line-height: 20px;
   cursor: pointer;
   transition: 0.3s;
}

/* When moving the mouse over the close button */
.closebtn:hover {
   color: black;
}
</style>
<script>
require([
    "jquery",
    "mage/mage",
    "mage/validation",
    "vue"
], ($, mage, validation, Vue) => {
    // initialize a new Vue app
    var app = new Vue({
      el: '#app',
      data: {
        categories: [],
        subcategories: [],
        lowestcategories: [],
        num_images: 9,
        local_global_error: false,
        image_error: false,
        form_data: {}
      }
    });

    $('#sell_form').submit(function(){
      if($(this).valid()){
        $.ajax({
          data: new FormData($(this)[0]),
          processData: false,
          contentType: false,
          url: $(this).attr('action'),
          type: $(this).attr('method'),
          showLoader: true,
          cache: true,
          success: function(data){
            if(data.error != undefined){
              $('#error-text').html(data.error);
              $('#error').show();
            }else if(data.success == 'Y'){
              window.location = '/customer/account/listings';
            }
          }
        });
        return false;
      }
    });


    // add custom validation to our form
    addCustomValidation();

    // initial api requests
    $.get('/api/categories', (data) => app.categories = data);

    // initialize validation
    $('#sell_form').mage('validation', {});

    // category change function
    $('#category_select').change(function() {
      let category = this.value;
      if(category == ''){
        app.subcategories = [];
        $('.subcategory').hide();
        $('.lowestcategory').hide();
      }else{
        app.subcategories = app.categories[category];
        $('#subcategory_select').val('');
        $('#lowestcategory_select').val('');
        $('.lowestcategory').hide();
        $('.subcategory').show();
      }
    });

    // subcategory change function
    $('#subcategory_select').change(function(){
      let subcategory = this.value;
      if(subcategory == ''){
        app.lowestcategories = [];
        $('.lowestcategory').hide();
      }else{
        app.lowestcategories = app.subcategories[subcategory];
        if(isNaN(app.lowestcategories)){
          $('#lowestcategory_select').val('');
          $('.lowestcategory').show();
        }
      }
    });

    // image change function
    $('.image_input, #image_0').change(function(event){
      let id = Number.parseInt((this.id.split('_'))[1]);
      $(`#image_${id}-error`).hide();
      $(`#image_${id+1}`).show();
    });

   // after everything loads, add our click handler
   $('#submit').prop('disabled', false);

   // click function for local checkbox
   $('#local').click(getLocation);
   var pos;
   /**************************************************
   ******************* FUNCTIONS *********************
   **************************************************/
   function getLocation() {
     // Try HTML5 geolocation
     if(!document.getElementById("local").checked || pos) return;
     if (navigator.geolocation) {
       $('#submit').prop('disabled', true);
       navigator.geolocation.getCurrentPosition(function(position) {
         pos = {
           lat: position.coords.latitude,
           lng: position.coords.longitude
         };
         $('#latitude').val(`${pos.lat}`);
         $('#longitude').val(`${pos.lng}`);
         $('#submit').prop('disabled', false);
       }, function() {
         document.getElementById("local").checked = false;
         alert('You must give Resold access to your location to post locally. Please allow location permissions by clicking the lock in the top left corner of the browser.');
         $('#submit').prop('disabled', false);
         handleLocationError(true, infoWindow, map.getCenter());
       });
     } else {
       // Browser doesn't support Geolocation
       handleLocationError(false, infoWindow, map.getCenter());
     }
   };
   function addCustomValidation() {
     $.validator.addMethod(
        'validate-local-global',
        function (value) {
            // custom validation
            if(!document.getElementById('local').checked && !document.getElementById('global').checked){
              app.local_global_error = true;
              return false;
            }
            app.local_global_error = false;
            return true;
          }
      );
  };
  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    infoWindow.setPosition(pos);
    infoWindow.setContent(browserHasGeolocation ? 'Error: The Geolocation service failed.' : 'Error: Your browser doesn\'t support geolocation.');
    infoWindow.open(map);
  };
});

<?php
if(isset($_GET['code']) && $_GET['code'] != null){
?>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.agent='dvapptrian';n.queue=[];
t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '165147020823726');
fbq('trackCustom', 'SellerRegistration', {});
<?php
}// end if user just signed up with stripe
?>
</script>
